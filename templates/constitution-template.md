# Constitution Template v0.3

Constitution — неизменные правила проекта, которым следуют все агенты.

## Что это

Constitution — это "конституция" проекта:
- Устанавливает границы того, что можно и нельзя
- Определяет стандарты качества
- Фиксирует технологический стек
- Не меняется в процессе выполнения

Агенты уровней **обязаны** следовать constitution. Нарушение = красный статус блока.

---

## Шаблон

```markdown
# Project Constitution

> Этот документ определяет неизменные правила проекта.
> Все агенты обязаны следовать этим правилам.
> Изменение constitution требует создания новой версии манифеста.

## 1. Технологический стек

### Языки и версии
- Python: 3.11+
- Node.js: 20+ (если используется)

### Фреймворки
- Backend API: FastAPI
- ORM: SQLAlchemy 2.0
- Валидация: Pydantic v2

### Базы данных
- Основная: PostgreSQL 15+
- Кеш: Redis 7+
- Очереди: Redis (или RabbitMQ)

### Инфраструктура
- Контейнеризация: Docker
- CI/CD: GitHub Actions

---

## 2. Стандарты кода

### Стиль
- Форматирование: black (Python), prettier (JS)
- Линтер: ruff (Python), eslint (JS)
- Максимальная длина строки: 100 символов

### Type hints
- **Обязательны** для всех функций
- **Обязательны** для параметров классов
- Использовать `from __future__ import annotations`

### Именование
- Файлы: snake_case
- Классы: PascalCase
- Функции и переменные: snake_case
- Константы: UPPER_SNAKE_CASE

### Документация
- Docstrings для всех публичных функций
- Формат: Google style
- README.md в каждом модуле

---

## 3. Архитектурные правила

### Структура проекта
```
src/
├── {module}/
│   ├── __init__.py
│   ├── service.py      # Бизнес-логика
│   ├── models.py       # Pydantic модели
│   ├── repository.py   # Работа с БД
│   └── routes.py       # API endpoints
tests/
├── {module}/
│   ├── test_service.py
│   └── test_routes.py
```

### Слои
- Routes → Service → Repository → Database
- Зависимости только сверху вниз
- Никаких циклических импортов

### API Design
- RESTful принципы
- Версионирование: /api/v1/
- Формат ответа: JSON
- Коды ответов по стандарту HTTP

---

## 4. Безопасность

### Критические правила
- ❌ НИКОГДА не коммитить secrets в код
- ❌ НИКОГДА не логировать пароли и токены
- ❌ НИКОГДА не использовать eval() или exec()

### Аутентификация
- JWT токены для API
- Refresh токены с ротацией
- Пароли: bcrypt с cost factor 12+

### Валидация
- Все входные данные валидируются через Pydantic
- SQL параметры через ORM (никакого raw SQL без параметризации)
- Санитизация пользовательского ввода

### Заголовки безопасности
- CORS настроен явно
- Content-Security-Policy
- X-Content-Type-Options: nosniff

---

## 5. Тестирование

### Требования
- Минимальное покрытие: 80%
- Unit тесты для всей бизнес-логики
- Integration тесты для API endpoints

### Инструменты
- pytest
- pytest-asyncio для async кода
- pytest-cov для покрытия
- httpx для тестирования API

### Правила
- Тесты не зависят друг от друга
- Каждый тест имеет понятное имя
- Моки только для внешних сервисов

---

## 6. Обработка ошибок

### Исключения
- Кастомные исключения наследуются от базового класса
- Все исключения логируются
- API возвращает структурированные ошибки

### Формат ошибки API
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Human readable message",
    "details": {}
  }
}
```

### Логирование
- Уровни: DEBUG, INFO, WARNING, ERROR, CRITICAL
- Формат: JSON в production
- Correlation ID для трейсинга

---

## 7. Производительность

### База данных
- Индексы для всех полей в WHERE/JOIN
- Пагинация обязательна для списков
- N+1 запросы запрещены

### API
- Таймаут для внешних вызовов: 30 секунд
- Rate limiting на публичных endpoints
- Кеширование где уместно

### Async
- Все I/O операции асинхронные
- Никаких блокирующих вызовов в async контексте

---

## 8. Что запрещено

Список того, что агенты НЕ должны делать:

- [ ] Устанавливать пакеты не из requirements.txt
- [ ] Использовать deprecated функции
- [ ] Игнорировать ошибки (bare except:)
- [ ] Хардкодить конфигурацию
- [ ] Создавать файлы вне структуры проекта
- [ ] Удалять существующие тесты
- [ ] Менять схему БД без миграции

---

## 9. Чеклист для агента

Перед завершением работы агент проверяет:

- [ ] Код отформатирован (black)
- [ ] Линтер не выдаёт ошибок (ruff)
- [ ] Type hints присутствуют
- [ ] Тесты написаны и проходят
- [ ] Документация обновлена
- [ ] Нет secrets в коде
- [ ] Нет TODO без issue номера
```

---

## Как использовать

### В манифесте

```yaml
constitution:
  path: "./constitution.md"
  checksum: "sha256:..."
```

### В контракте блока

```yaml
constraints:
  from_constitution:
    - "security.no_secrets_in_code"
    - "style.type_hints_required"
    - "testing.minimum_coverage"
```

### Агент при выполнении

1. Загружает constitution
2. Проверяет checksum (не изменился ли)
3. Применяет правила при генерации кода
4. Валидирует результат против чеклиста

---

## Версионирование constitution

Constitution не меняется в рамках одного манифеста.

Если нужно изменить правила:
1. Создать новую версию constitution
2. Создать новый манифест с новой версией
3. Перезапустить проект с нового манифеста

```
constitutions/
├── constitution-v1.md
├── constitution-v2.md
└── constitution-current.md → symlink
```
